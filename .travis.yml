dist: trusty
sudo: required
language: java
os:
 - linux
 - osx

install:
 - ./travis_install.sh
# Skip gradlew assemble since build is a superset

script:
 - ./gradlew build

# Taken from docs but with additions
before_cache:
 - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
 - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
 - rm -f  $HOME/.gradle/caches/*/fileHashes/fileHashes.bin
 - rm -f  $HOME/.gradle/caches/*/fileHashes/fileHashes.lock
cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/

addons:
  ssh_known_hosts: sftp.infinityphase.com:2222

after_success:
 - du -sh Pathfinder-*
 - zip -9 -r built_core Pathfinder-Core/build/libs/pathfinder
 - zip -9 -r built_java Pathfinder-Java/build/libs
 - openssl aes-256-cbc -iv $iv_hex -K $key_hex -in upload_key_encrypted -out upload_key -d
 - chmod 600 upload_key
 - eval $(ssh-agent -s) > /dev/null
 - ssh-add upload_key > /dev/null
 - echo "Commit SHA $TRAVIS_COMMIT" > COMMIT_TIMESTAMP
 - echo "Branch $TRAVIS_BRANCH" >> COMMIT_TIMESTAMP
 - echo "Build $TRAVIS_BUILD_NUMBER" >> COMMIT_TIMESTAMP
 - date >> COMMIT_TIMESTAMP
 - cat COMMIT_TIMESTAMP
 - sha256sum built_core.zip | tee sha256sums
 - sha256sum built_java.zip | tee -a sha256sums
 - sha256sum COMMIT_TIMESTAMP | tee -a sha256sums
 - cat sha256sums
 - envsubst < upload_sftp > upload_sftp_subst
 - sftp -v -b upload_sftp_subst -i upload_key -P 2222 $sftp_user
 - eval $(ssh-agent -k) > /dev/null
 - rm upload_key
